# Formura 概要
この節では、 Formura の概要について述べる。
Formura の開発目的、基本的な考え方、Formura の出力するコードの動作について概説する。

- 開発目的
- 基本的な考え方
- コードの動作

## 開発目的
Formura は、ステンシル計算のための DSL (Domain Specific Language) である。
ステンシル計算は、流体の陽解法やセルオートマトンのように局所的な情報を使って計算を進めることができる種類の計算である。

Formura は、より多くの人が大規模なステンシル計算を実行するのを助け、科学の進歩に貢献する。

## 基本的な考え方
Formura の基本的な考え方について記述する。

Formura は
「ステンシル計算では、必要な変数と1点の更新方法だけわかれば、通信やブロッキングといった部分のコードは機械的に生成できるはずだ」
という考えを実現するプロジェクトである。

Formura は、

- 数値スキームの記述に適した文法
- 計算機の事情を考えなくても大規模計算が可能なコード

をユーザーに提供する。
Formura のユーザーは、表現力の高い言語で数値スキームを記述でき、効率的なデータ構造やプロセス間通信の方法を気にしなくてもよい。


### ユーザーと Formura の役割分担
Formura は、ユーザーが与えるステンシル計算の記述と数値設定(MPIのプロセス数や系の大きさなど)から C のライブラリを生成する。
このライブラリに含まれる API については[チュートリアル]()の付録Aに記述がある。
ユーザーは、このライブラリを呼び出すドライバコードも記述する必要がある。
ドライバコードでは、Formura が生成した API を呼び出し、初期化を行い、ステンシル計算を進め、必要に応じてデータをファイルへ書き出し、終了処理を行う。


## コードの動作
Formura が生成するコードの動作について概説する。

Formura は、グローバル配列と `Formura_Navi` 構造体を使って必要な情報を保持する。
グローバル配列は、時間発展する変数を保持するデータ構造である。
この配列の変数名は、デフォルトで `formura_data` であり、ユーザーが別の名前を指定することもできる。
`Formura_Navi` 構造体は、現在の時間ステップやノードあたりの格子数、格子間隔などを保持している。
これらが保持する情報の詳細は、チュートリアルの付録Aに記述されている。

Formura は次の関数を提供する。それぞれの動作を順に解説する。

- `Formura_Init` 関数
- `Formura_Custom_Init` 関数
- `Formura_Forward` 関数
- `Formura_Finalize` 関数
- 補助関数 (`to_pos_x` 関数など)

`Formura_Init` 関数は、MPI、グローバル配列、 `Formura_Navi` 構造体の初期化を行う。
ユーザーが MPI コミュニケータを指定したい場合は、 `Formura_Custom_Init` 関数を使う。

`Formura_Forward` 関数は、一定のタイムステップだけ計算を進めるものである。
一定のタイムステップとは、ユーザーが指定した `temporal_blocking_interval` に一致する。
この関数は、プロセス間で通信を行い、グローバル配列を更新する。

`Formura_Finalize` 関数は、MPIの終了処理を行う。

補助関数(`to_pos_x` 関数)は、配列のインデックスと座標を対応づける関数である。
`Formura_Forward` 関数で計算を進めるときに、配列のインデックスと座標がずれることがある。
このずれを補正するのが、補助関数の役割である。
